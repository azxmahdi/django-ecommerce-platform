{% extends "account/base.html" %}

{% block extra_css %}
<style>
  .otp-input {
    @apply w-48 h-14 text-2xl border border-gray-300 
           rounded-lg text-center bg-white dark:bg-gray-800
           focus:outline-none focus:ring-2 focus:ring-indigo-500;
    letter-spacing: .75rem; 
  }
</style>
{% endblock extra_css %}

{% block title %} {{page_title}} {% endblock title %}

{% block content %}
<div class="flex min-h-screen items-center justify-center bg-background">
  <div class="container max-w-md">
    <div class="bg-muted p-8 rounded-xl shadow-md">
      <h1 class="text-lg mb-6 text-center">کد تایید را وارد کنید</h1>

      <form id="otp-form" method="post">
        {% csrf_token %}
        <div class="flex justify-center mb-4">
          <input
            type="text"
            name="code"
            id="otp-input"
            inputmode="numeric"
            pattern="\d*"
            maxlength="{{ settings.OTP_CODE_LENGTH }}"
            autocomplete="one-time-code"
            placeholder=""
            class="otp-input"
          />
        </div>

        <p id="otp-error" class="h-5 text-sm text-red-500"></p>

        <p id="countdownSection"
           class="text-primary text-sm mb-4 hidden text-center">
          زمان باقی‌مانده تا ارسال مجدد
          <span id="countdown" class="font-bold"></span>
        </p>

        <div class="flex justify-center mb-6">
          <button
            id="resendButton"
            type="button"
            class="text-sm text-primary underline disabled:opacity-50 flex items-center gap-1"
            disabled
          >
            ارسال مجدد
            <svg class="h-5 w-5 inline-block"><use xlink:href="#chevron-left"/></svg>
          </button>
        </div>
        
        <button
          type="submit"
          class="btn-primary w-full py-3"
        >
          تایید
        </button>
      </form>

      <div id="otp-alert" class="text-sm mt-4 text-center h-5"></div>
    </div>
  </div>
</div>
{% endblock content %}
{% block extra_js %}
<script>
  const SEND_OTP_URL = "{% url 'account:send-otp' %}";
  const CSRF_TOKEN   = "{{ csrf_token }}";
  const OTP_EXPIRY   = {{ otp_expiry }};
  const OTP_LENGTH   = {{ otp_length }};     

  document.addEventListener('DOMContentLoaded', () => {
    const resendBtn    = document.getElementById('resendButton');
    const countdownDiv = document.getElementById('countdownSection');
    const countdownEl  = document.getElementById('countdown');
    const alertBox     = document.getElementById('otp-alert');
    const errorBox     = document.getElementById('otp-error');
    const otpInput     = document.getElementById('otp-input');

    otpInput.maxLength   = OTP_LENGTH;
    otpInput.placeholder = '•'.repeat(OTP_LENGTH);

    let timerId = null, remaining = 0;

    function renderTime(sec) {
      const m = Math.floor(sec/60), s = sec%60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function startTimer(duration = OTP_EXPIRY) {
      clearInterval(timerId);
      remaining = duration;

      resendBtn.disabled = true;
      countdownDiv.classList.remove('hidden');
      countdownEl.textContent = renderTime(remaining);

      timerId = setInterval(() => {
        remaining--;
        countdownEl.textContent = renderTime(remaining);

        if (remaining <= 0) {
          clearInterval(timerId);
          resendBtn.disabled = false;
          countdownDiv.classList.add('hidden');
          localStorage.removeItem('otpSent');
          localStorage.removeItem('otpRemaining');
          localStorage.removeItem('otpExpiryTime');
        }
      }, 1000);
    }

    function showAlert(text, isError = false) {
      alertBox.textContent = text;
      alertBox.classList.toggle('text-red-500', isError);
      alertBox.classList.toggle('text-green-600', !isError);
    }

    async function ajaxSendOTP() {
      showAlert('در حال ارسال...', false);
      try {
        const resp = await fetch(SEND_OTP_URL, {
          method: 'POST',
          headers: { 
            'X-CSRFToken': CSRF_TOKEN, 
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });
        const data = await resp.json();

        if (data.status === 'success') {
          showAlert(data.message, false);
          startTimer(data.expiry || OTP_EXPIRY);
          localStorage.setItem('otpSent', 'true');
          localStorage.setItem('otpExpiryTime', Date.now().toString());
          localStorage.setItem('otpRemaining', (data.expiry || OTP_EXPIRY).toString());
        } else {
          showAlert(data.message, true);
          if (data.remaining_time) {
            startTimer(data.remaining_time);
          }
        }
      } catch (error) {
        showAlert('خطا در ارتباط با سرور', true);
        console.error('Send OTP error:', error);
      }
    }

    const hasSentOTP    = localStorage.getItem('otpSent') === 'true';
    const savedExpiry   = localStorage.getItem('otpExpiryTime');
    const savedRemaining= localStorage.getItem('otpRemaining');

    if (hasSentOTP && savedExpiry && savedRemaining) {
      const timePassed    = Math.floor((Date.now() - parseInt(savedExpiry)) / 1000);
      const remainingTime = Math.max(0, parseInt(savedRemaining) - timePassed);
      
      if (remainingTime > 0) {
        startTimer(remainingTime);
        showAlert('کد قبلاً ارسال شده است', false);
      } else {
        localStorage.removeItem('otpSent');
        localStorage.removeItem('otpRemaining');
        localStorage.removeItem('otpExpiryTime');
        ajaxSendOTP(); 
      }
    } else {
      ajaxSendOTP();
    }

    resendBtn.addEventListener('click', () => {
      ajaxSendOTP();
    });

    {% if form.errors.code %}
      errorBox.textContent = "{{ form.errors.code.0 }}";
    {% endif %}
  });
</script>
{% endblock extra_js %}
