{% extends "account/base.html" %}
{% load static %}

{% block title %} ورود {% endblock title %}

{% block content %}
  
  <div class="sr-only">
  </div>

  <div class="flex min-h-screen items-center justify-center bg-background">
    <div class="container">
      <div class="relative mx-auto max-w-[450px] rounded-xl bg-muted p-5 shadow-base md:p-10">

        <a
          href="{% url 'account:phone-auth' %}"
          class="absolute -top-3.5 -right-3.5 dark:hover:bg-muted shadow-base hover:bg-muted text-white hover:text-primary transition-all duration-200 w-10 h-10 flex items-center justify-center rounded-full bg-primary"
        >
          <svg class="w-8 h-8">
            <use xlink:href="#chevron-right" />
          </svg>
        </a>

        <a href="{% url 'account:phone-auth' %}">
          <img
            src="{% static 'assets/images/logo.svg' %}"
            class="mx-auto mb-10 w-40"
            alt="Logo"
          />
        </a>

        <h1 class="mb-10 text-lg">کلمه عبور را وارد کنید</h1>

        <form method="POST">
          <input type="hidden" id="phone" value="{{ user_phone }}" />
          {% csrf_token %}
          

          <div class="mb-4 space-y-4">
            <label for="password" class="relative block rounded-lg border shadow-base">
              <input
                type="password"
                id="password"
                name="password"
                dir="auto"
                class="peer w-full rounded-lg border-none bg-transparent p-4 text-left placeholder-transparent focus:outline-hidden focus:ring-0"
                placeholder="کلمه عبور"
                required
              />
              <span
                class="pointer-events-none absolute start-2.5 top-0 -translate-y-1/2 bg-muted px-2 py-0.5 text-sm text-text/90 transition-all peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-base peer-focus:top-0 peer-focus:text-sm"
              >
                کلمه عبور
              </span>
            </label>
          </div>

          <ul class="mb-8 space-y-4">

            <li>
              <a
                href="#"
                id="otp-login-btn"
                data-send-otp-url="{% url 'account:send-otp' %}"
                data-login-otp-url="{% url 'account:login-otp' %}"
                class="btn-primary-nobg text-sm w-fit flex items-center gap-2"
              >
                <span id="otp-icon">
                  <svg class="h-5 w-5">
                    <use xlink:href="#chevron-left" />
                  </svg>
                </span>
                <span id="otp-spinner" class="hidden animate-spin">
                  <svg class="h-5 w-5">
                    <use xlink:href="#svg-spinners-3-dots-scale" />
                  </svg>
                </span>
                <span id="otp-text">ورود با رمز یک بار مصرف</span>
              </a>
            </li>

            <li>
              <a
                href="#"
                id="forgot-otp-btn"
                data-send-otp-url="{% url 'account:send-otp' %}"
                data-forgot-otp-url="{% url 'account:forgot-otp' %}"
                class="btn-primary-nobg text-sm w-fit flex items-center gap-2"
              >
                <span id="forgot-icon">
                  <svg class="h-5 w-5">
                    <use xlink:href="#chevron-left" />
                  </svg>
                </span>
                <span id="forgot-spinner" class="hidden animate-spin">
                  <svg class="h-5 w-5">
                    <use xlink:href="#svg-spinners-3-dots-scale" />
                  </svg>
                </span>
                <span id="forgot-text">فراموشی رمز عبور</span>
              </a>
            </li>

          </ul>

          <div>
            <button type="submit" class="btn-primary w-full py-3">
              ورود
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock content %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const msg    = sessionStorage.getItem('otpMessage');
      const status = sessionStorage.getItem('otpStatus');
      if (msg) {
        Toastify({
          text: msg,
          className: status === 'success' ? 'success' : 'error',
          style: { background: status === 'success' ? 'green' : 'red' }
        }).showToast();
        sessionStorage.removeItem('otpMessage');
        sessionStorage.removeItem('otpStatus');
      }

      const phoneInput = document.getElementById('phone').value;
      const csrftoken  = document.querySelector('input[name=csrfmiddlewaretoken]').value;

      const otpBtn = document.getElementById('otp-login-btn');
      if (otpBtn) {
        otpBtn.addEventListener('click', function(e) {
          e.preventDefault();

          const btn     = this;
          const icon    = document.getElementById('otp-icon');
          const spinner = document.getElementById('otp-spinner');
          const textEl  = document.getElementById('otp-text');

          btn.classList.add('pointer-events-none', 'opacity-50');
          icon.classList.add('hidden');
          spinner.classList.remove('hidden');
          textEl.textContent = 'در حال ارسال…';

          fetch(btn.dataset.sendOtpUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phone: phoneInput })
          })
          .then(res => res.json())
          .then(data => {
            sessionStorage.setItem('otpMessage', data.message);
            sessionStorage.setItem('otpStatus', data.status);
            window.location.href = btn.dataset.loginOtpUrl;
          })
          .catch(() => {
            Toastify({
              text: 'خطا در ارسال درخواست',
              className: 'error',
              style: { background: 'red' }
            }).showToast();
          })
          .finally(() => {
            btn.classList.remove('pointer-events-none', 'opacity-50');
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            textEl.textContent = 'ورود با رمز یک بار مصرف';
          });
        });
      }

      const forgotBtn = document.getElementById('forgot-otp-btn');
      if (forgotBtn) {
        forgotBtn.addEventListener('click', function(e) {
          e.preventDefault();

          const btn     = this;
          const icon    = document.getElementById('forgot-icon');
          const spinner = document.getElementById('forgot-spinner');
          const textEl  = document.getElementById('forgot-text');

          btn.classList.add('pointer-events-none', 'opacity-50');
          icon.classList.add('hidden');
          spinner.classList.remove('hidden');
          textEl.textContent = 'در حال ارسال…';

          fetch(btn.dataset.sendOtpUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phone: phoneInput })
          })
          .then(res => res.json())
          .then(data => {
            sessionStorage.setItem('otpMessage', data.message);
            sessionStorage.setItem('otpStatus', data.status);
            window.location.href = btn.dataset.forgotOtpUrl;
          })
          .catch(() => {
            Toastify({
              text: 'خطا در ارسال درخواست',
              className: 'error',
              style: { background: 'red' }
            }).showToast();
          })
          .finally(() => {
            btn.classList.remove('pointer-events-none', 'opacity-50');
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            textEl.textContent = 'فراموشی رمز عبور';
          });
        });
      }
    });
  </script>
{% endblock extra_js %}